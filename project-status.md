# LanFile_PC 项目状态报告

## 当前进展

- 完成了基础项目设置
- 完成了 Electron 主进程和渲染进程的配置
- 完成了主题系统的搭建
- 实现了基础 UI 组件的响应式布局
- 集成了文件选择功能
- 选择了 MDNS 作为局域网设备发现方案
- 安装了 MDNS 依赖 (multicast-dns)
- 配置完成 TailwindCSS 和 PostCSS
- 实现了设备扫描器的雷达动画效果
- 优化了 MDNS 服务实现和错误处理

## 下一步计划

- 实现 HTTP 服务器
- 配置 MDNS 服务广播
- 开发设备发现功能

## 技术栈

- Electron
- React
- TypeScript
- TailwindCSS
- Headless UI
- MDNS (multicast-dns)
- WebRTC (计划中)
- WebTorrent (计划中)

## 技术方案

### 1. 前端架构

- **UI 框架**: React + TypeScript

  - 使用函数式组件和 Hooks
  - 严格的类型检查
  - 组件按功能模块化组织

- **样式方案**: TailwindCSS

  - 使用 PostCSS 处理器
  - 自定义主题配置
  - 组件级样式封装
  - 响应式设计支持

- **构建工具**: Webpack
  - 多目标构建配置（主进程、渲染进程、预加载脚本）
  - 热重载开发环境
  - 资源优化和代码分割

### 2. 桌面端实现

- **框架选择**: Electron

  - 主进程负责系统 API 调用
  - 渲染进程处理 UI 交互
  - IPC 通信处理跨进程操作

- **文件系统集成**:
  - 使用 Electron 的 dialog API 处理文件选择
  - Node.js fs 模块处理文件读写
  - 支持拖拽操作

### 3. 网络传输

- **设备发现**: MDNS (Multicast DNS)

  - 使用 multicast-dns 包实现
  - 自动服务发现和注册
  - 零配置网络实现

- **文件传输**:
  - HTTP 服务器处理文件传输（计划中）
  - WebRTC 实现点对点传输（计划中）
  - WebTorrent 支持大文件传输（计划中）

### 4. 安全性

- **IPC 通信安全**:

  - contextBridge 严格限制暴露 API
  - 类型安全的 IPC 接口
  - 输入验证和清理

- **文件传输安全**:
  - 传输过程加密（计划中）
  - 文件完整性校验（计划中）
  - 访问控制和认证（计划中）

### 7. MDNS 服务优化

- 问题: MDNS 服务存在稳定性和性能问题
- 解决: 全面优化 MDNS 服务实现
- 实现细节:
  - 使用正确的 MDNS 记录格式 (PTR, SRV, TXT)
  - 添加 TTL (生存时间) 设置
  - 使用 Buffer 来存储 TXT 记录的数据
  - 优化了设备信息的传输方式
- 错误处理优化:
  - 在所有关键操作中添加 try-catch 块
  - 添加了详细的错误日志
  - 确保即使出错也不会阻塞 UI
- 服务发现机制改进:
  - 正确发布本机服务信息
  - 使用标准的 MDNS 记录格式
  - 优化了设备信息的传输
- 资源管理优化:
  - 确保在停止服务时正确清理所有资源
  - 添加了额外的错误处理
- 技术要点:
  - MDNS 协议标准实现
  - 错误处理最佳实践
  - 资源生命周期管理
  - Buffer 数据处理
  - 事件监听和清理机制

### 8. 心跳服务优化

- 问题: 心跳服务存在启动和检测问题，导致设备无法正确检测在线状态
- 解决: 优化心跳服务启动流程和状态检查功能
- 实现细节:
  - 统一心跳服务端口为 8080（从原有的 8899 修改）
  - 在应用启动时优先启动心跳服务，确保服务可用
  - 修改 `HeartbeatService` 中的 `isRunning` 属性为公共，以便外部访问状态
  - 使用 `0.0.0.0` 作为绑定地址，确保监听所有网络接口
  - 优化心跳服务器的错误处理，添加详细日志
  - 规范化 HTTP 检测路径为 `/lanfile/status`
  - 在 `NetworkService` 中统一使用 `DEFAULT_HEARTBEAT_PORT` 常量
- 网络检测优化:
  - 增强 HTTP 检测的错误处理和日志
  - 为设备状态检查添加超时控制
  - 添加详细的心跳检测日志，便于调试
  - 跳过网络连接检查，直接进行设备心跳检测
- 用户体验改进:
  - 在设置页面添加诊断按钮，允许用户检查心跳服务状态
  - 显示心跳服务的运行状态和端口信息
- 技术要点:
  - HTTP 服务器配置最佳实践
  - 网络接口绑定配置
  - 异步服务启动顺序管理
  - 详细的状态监控和日志记录

### 9. 文件传输 UI 优化

- 问题: 文件传输进度条不显示、重复传输项显示、设备名称显示不友好
- 解决: 全面优化文件传输 UI 和状态管理机制
- 实现细节:
  - 重构 `CurrentTransfers` 组件的渲染逻辑
  - 添加传输项去重机制，确保每个文件只显示最新状态
  - 实现基于设备名称而非 peerId 的显示，增强用户体验
  - 添加传输状态缓存，解决 React 异步更新导致的进度更新问题
  - 优化进度条动画和渲染逻辑，确保流畅更新
  - 改进传输项排序逻辑，优先显示活动传输
  - 添加强制刷新机制，确保活动传输状态实时更新
- 状态管理优化:
  - 在 `usePeerJS` 钩子中添加传输缓存，确保状态一致性
  - 优化 ID 生成机制，防止传输任务 ID 冲突
  - 实现了设备名称映射，使用友好名称代替技术 ID
  - 添加详细日志，便于问题排查和性能分析
- 代码组织改进:
  - 将 `TransferItem` 组件与传输逻辑解耦，提高可维护性
  - 添加状态验证，确保传输进度、速度等数据的准确性
  - 使用 `useMemo` 优化渲染性能，避免不必要的重新计算
- 技术要点:
  - React 状态更新的异步特性处理
  - React.memo 和 useMemo 性能优化
  - 组件渲染生命周期管理
  - 复杂 UI 交互状态同步
  - 进度动画平滑过渡实现

## 开发指南

### 1. 环境要求

- Node.js >= 16.0.0
- npm >= 8.0.0
- Git

### 2. 项目设置

```bash
# 克隆项目
git clone

# 进入项目目录
cd LanFile_PC

# 安装依赖
npm install
```

### 3. 开发模式

```bash
# 启动开发服务器
npm run dev

# 这个命令会：
# 1. 启动 webpack-dev-server（渲染进程）
# 2. 启动 electron（主进程）
# 3. 启动热重载
```

### 4. 构建项目

```bash
# 构建生产版本
npm run build

# 这个命令会：
# 1. 构建渲染进程
# 2. 构建主进程
# 3. 构建预加载脚本
```

### 5. 常见问题

1. **端口占用问题**

   - 默认使用 3001 端口
   - 如果端口被占用，可以修改 `webpack.config.ts` 中的端口配置

2. **热重载不生效**

   - 检查 webpack-dev-server 是否正常运行
   - 确认 webpack 配置中的 hot 选项已启用

3. **样式不生效**
   - 确保 PostCSS 配置正确
   - 检查 TailwindCSS 配置文件是否正确
   - 确认样式文件正确导入

### 6. 开发工具推荐

- VS Code 扩展：
  - ESLint
  - Prettier
  - Tailwind CSS IntelliSense
  - TypeScript Vue Plugin (Volar)
  - Error Lens

## 问题解决记录

### 1. UI 组件系统搭建

- 问题: 需要高度可定制且无障碍的 UI 组件
- 解决: 使用 Headless UI + TailwindCSS 组合
- 实现: 封装了 Button、Card 等基础组件

### 2. Electron 渲染进程通信

- 问题: 主进程和渲染进程之间的通信配置
- 解决: 通过 contextBridge 配置预加载脚本,暴露安全的 API

### 3. 文件选择实现

- 问题: 需要实现跨平台的文件选择功能
- 解决: 使用 Electron 的 dialog API
- 步骤: 通过 IPC 在渲染进程中调用主进程的文件选择功能

### 4. 样式优化

- 问题: 样式管理和响应式设计
- 解决: 使用 TailwindCSS 实现统一的样式系统
- 创建统一的主题系统，包含颜色、间距和排版规范
- 解决了 TailwindCSS 的 @apply 和 @tailwind 指令问题
- 配置了 PostCSS 以支持 TailwindCSS 的所有功能

### 5. 设备发现方案选择

- 问题: 需要在局域网内实现自动设备发现
- 解决: 选择 MDNS (Multicast DNS) 协议
- 实现: 使用 multicast-dns 包实现 MDNS 服务
- 原因:
  - 无需中心服务器，完全点对点
  - 原生支持局域网服务发现
  - 跨平台兼容性好
  - 低延迟，实时性强

### 6. 雷达扫描器实现

- 问题: 需要实现一个专业的设备扫描可视化界面
- 解决: 使用 Canvas 实现雷达扫描效果
- 实现细节:
  - 使用 requestAnimationFrame 实现平滑动画
  - 使用 Canvas 绘制雷达背景、扫描线和设备标记
  - 通过 useRef 管理动画状态，避免重渲染问题
  - 使用线性渐变实现扫描线发光效果
  - 设备显示与扫描线同步，实现渐现效果
- 优化:
  - 扫描周期设置为 3 秒，提供流畅的视觉体验
  - 使用 rgba 颜色实现半透明效果
  - 设备图标固定位置显示，避免闪烁
  - 优化性能，避免不必要的重绘
- 技术要点:
  - Canvas 2D Context API
  - React useRef 和 useEffect Hooks
  - requestAnimationFrame 动画循环
  - 极坐标系转换
  - 事件监听和清理
